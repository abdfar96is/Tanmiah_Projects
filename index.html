<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>نطاقات المشاريع التنموية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; direction: rtl; }
    #title {
      background: #004c6d; color: white; text-align: center;
      padding: 15px; font-size: 24px; font-weight: bold; position: relative;
    }
    #title img { position: absolute; top: 5px; height: 50px; }
    #title img.right-logo { right: 1px; }
    #title img.left-logo { left: 1px; }
    #map { height: 88vh; width: 100%; position: absolute; }
    #dropdown {
      position: absolute; top: 85px; right: 15px; z-index: 1000;
      padding: 8px; font-size: 16px; background: #fff; border-radius: 6px; border: 1px solid #ccc;
      max-width: 60vw;
    }
    .legend { background: #fff; padding: 8px 10px; border-radius: 6px; line-height: 1.6; box-shadow: 0 1px 4px rgba(0,0,0,.2); }
    .legend i { display:inline-block; width:14px; height:14px; margin-left:6px; border:1px solid #00000033; vertical-align: -2px; }
  </style>
</head>
<body>

<div id="title">
  <img src="https://gis.tanmiah.gov.sa/tanmiahsaudi/assets/Tanmiah_logo.svg" class="right-logo" alt="logo">
  نطاقات المشاريع التنموية
  <img src="https://gis.tanmiah.gov.sa/tanmiahsaudi/assets/Tanmiah_logo.svg" class="left-logo" alt="logo">
</div>

<select id="dropdown">
  <option selected disabled>اختر المشروع</option>
</select>

<div id="map"></div>

<script>
  // خريطة مع تفعيل أنيميشن التكبير
  const map = L.map('map', {
    center: [23.5, 44.5],
    zoom: 6,
    zoomControl: false,
    zoomAnimation: true,
    zoomAnimationThreshold: 4,
    fadeAnimation: true
  });

  // طبقات أساس (تحديث أثناء التكبير لنعومة أفضل)
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap',
    updateWhenZooming: true,
    keepBuffer: 4
  }).addTo(map);

  const esriImagery = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles © Esri',
    updateWhenZooming: true,
    keepBuffer: 4
  });

  L.control.layers({ "خريطة الأساس": osm, "صورة الأقمار الصناعية": esriImagery }, null, { position: 'topleft' }).addTo(map);

  // ألوان الحالة
  const STATUS_COLORS = { "منتهي": "#3E8F63", "قيد التنفيذ": "#B3D238", "قيد التخطيط": "#EDC65A" };
  const DEFAULT_COLOR = "#B3B3B3";
  const STATUS_LABELS = { "1": "قيد التخطيط", "2": "قيد التنفيذ", "3": "منتهي" };

  const getStatusKey = (v) => v == null ? "" : String(v).trim();
  const getStatusColor = (v) => STATUS_COLORS[getStatusKey(v)] || DEFAULT_COLOR;
  const getStatusLabel = (v) => STATUS_LABELS[getStatusKey(v)] || "غير محدد";

  // القاموس النهائي
  const REGION_BY_PROJECT = {
    // منطقة تبوك
    "نيوم المرحلة الثانية - مركز المويلح": "منطقة تبوك",
    "نيوم المرحلة الثانية - مركز شقري": "منطقة تبوك",
    "نيوم المرحلة الثانية - مركز السرو": "منطقة تبوك",
    "نيوم المرحلة الثانية - جنوب البدع": "منطقة تبوك",
    "نيوم المرحلة الثانية - مركز الزيتة": "منطقة تبوك",
    "نيوم المرحلة الثالثة": "منطقة تبوك",
    "نيوم المرحلة الأولى - شرما": "منطقة تبوك",
    "نيوم المرحلة الأولى - شرماء": "منطقة تبوك",
    "نيوم المرحلة الأولى - الخريبة": "منطقة تبوك",
    "نيوم المرحلة الأولى - قيال": "منطقة تبوك",
    "وادي الديسة": "منطقة تبوك",
    "نيوم المرحلة الأولى - مقنا": "منطقة تبوك",
    "البحر الأحمر - المرحلة الأولى": "منطقة تبوك",
    "آمالا الخلجان الثلاثة": "منطقة تبوك",
    "امالا": "منطقة تبوك",
    "نيوم المرحلة الأولى - جنوب المينا": "منطقة تبوك",
    "نيوم المرحلة الرابعة": "منطقة تبوك",

    // المنطقة الشرقية
    "مشروع بالم الأحساء": "المنطقة الشرقية",
    "مشروع بلم الأحساء": "المنطقة الشرقية",
    "مشروع تطوير ساحل محافظة الخفجي": "المنطقة الشرقية",

    // منطقة الرياض
    "مشروع الرياض رايز": "منطقة الرياض",
    "مشروع بوتيك الرياض - قصر الملك سعود": "منطقة الرياض",
    "شركة المربع للتطوير - الرياض هب": "منطقة الرياض",
    "مشروع بحيرة الرياض - السفارات": "منطقة الرياض",
    "وسط الرياض": "منطقة الرياض",
    "وصلة الرياض": "منطقة الرياض",

    // منطقة المدينة المنورة
    "العلا المرحلة الأولى": "منطقة المدينة المنورة",
    "العلا المرحلة الأولى - الأولوية الأولى - 4 مزارع": "منطقة المدينة المنورة",
    "مشروع الخط الكهربائي الناقل - محطة ينبع": "منطقة المدينة المنورة",
    "العلا المرحلة الثانية": "منطقة المدينة المنورة",
    "العلا - المرحلة الثالثة": "منطقة المدينة المنورة",

    // منطقة حائل
    "محمية المسمى": "منطقة حائل",

    // منطقة عسير
    "مشروع سلوان": "منطقة عسير",
    "الوادي للتطوير - أبها": "منطقة عسير",
    "السودة": "منطقة عسير",

    // منطقة مكة المكرمة
    "رؤى الحرم - المرحلة الأولى": "منطقة مكة المكرمة",
    "رؤى الحرم - المرحلة الثانية": "منطقة مكة المكرمة",
    "مشروع قناة جدة المائية": "منطقة مكة المكرمة",
    "خليج سلمان": "منطقة مكة المكرمة",
    "جبل الشفا": "منطقة مكة المكرمة",
    "برنامج جدة التاريخية": "منطقة مكة المكرمة"
  };

  function getRegionName(projectName) {
    return REGION_BY_PROJECT[projectName] || "غير مُصنف";
  }

  // دالة تكبير/تحريك ناعم إلى حدود معينة
  function smoothZoomTo(bounds, padding = [20, 20]) {
    if (!bounds || !bounds.isValid()) return;
    // إن كانت المساحة صغيرة جداً، حدّد أقصى مستوى تكبير اختياريًا
    const options = {
      padding,
      animate: true,
      duration: 1.2,       // مدة الحركة بالثواني
      easeLinearity: 0.2,  // ليونة الحركة
      noMoveStart: false
    };
    if (map.flyToBounds) {
      map.flyToBounds(bounds, options);
    } else {
      map.fitBounds(bounds, { padding });
    }
  }

  let features = [];
  let fullLayerGroup;
  let selectedLayer;

  fetch('Projects_Boundary.json')
    .then(res => res.json())
    .then(geojson => {
      features = geojson.features || [];

      // طبقة جميع المشاريع
      fullLayerGroup = L.geoJSON(geojson, {
        style: (feature) => ({
          color: 'black',
          weight: 0.7,
          fillColor: getStatusColor(feature.properties?.Project_Status),
          fillOpacity: 0.55
        }),
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          const name = p.Project_Name || 'بدون اسم';
          const statusLabel = getStatusLabel(p.Project_Status);
          const area = p.Area_km2 ? Number(p.Area_km2).toFixed(1) : "غير متوفر";
          const region = getRegionName(name);
          layer.bindPopup(`${name}<br>الحالة: ${statusLabel}<br>المساحة: ${area} كم²`);
        }
      }).addTo(map);

      // تعبئة القائمة
      const dropdown = document.getElementById('dropdown');

      // خيار "كل المشاريع"
      const allOption = document.createElement('option');
      allOption.value = 'all';
      allOption.textContent = 'كل المشاريع';
      dropdown.appendChild(allOption);

      // بناء المجموعات {منطقة: Set(مشاريع)}
      const groups = new Map();
      for (const f of features) {
        const p = f.properties || {};
        const proj = p.Project_Name && String(p.Project_Name).trim();
        if (!proj) continue;
        const region = getRegionName(proj);
        if (!groups.has(region)) groups.set(region, new Set());
        groups.get(region).add(proj);
      }

      // ترتيب عربي
      const collator = new Intl.Collator('ar');
      const sortedRegions = Array.from(groups.keys()).sort((a, b) => collator.compare(a, b));

      for (const region of sortedRegions) {
        const og = document.createElement('optgroup');
        og.label = region;
        const projectsSorted = Array.from(groups.get(region)).sort((a, b) => collator.compare(a, b));
        for (const proj of projectsSorted) {
          const opt = document.createElement('option');
          opt.value = proj;
          opt.textContent = proj;
          og.appendChild(opt);
        }
        dropdown.appendChild(og);
      }

      // تفاعل القائمة
      dropdown.addEventListener('change', () => {
        const val = dropdown.value;

        if (selectedLayer) {
          map.removeLayer(selectedLayer);
          selectedLayer = null;
        }

        if (val === 'all') {
          if (!map.hasLayer(fullLayerGroup)) map.addLayer(fullLayerGroup);
          const b = fullLayerGroup.getBounds();
          if (b.isValid()) smoothZoomTo(b, [30, 30]);
          return;
        }

        // إخفاء الطبقة الكاملة عند اختيار مشروع محدد
        if (map.hasLayer(fullLayerGroup)) map.removeLayer(fullLayerGroup);

        const filtered = features.filter(f => String(f.properties?.Project_Name).trim() === String(val).trim());
        const fc = { type: "FeatureCollection", features: filtered };

        selectedLayer = L.geoJSON(fc, {
          style: (feature) => ({
            color: '#000',
            weight: 1.2,
            fillColor: getStatusColor(feature.properties?.Project_Status),
            fillOpacity: 0.75
          }),
          onEachFeature: (feature, layer) => {
            const p = feature.properties || {};
            const nm = p.Project_Name || 'بدون اسم';
            const stLabel = getStatusLabel(p.Project_Status);
            const area = p.Area_km2 ? Number(p.Area_km2).toFixed(1) : "غير متوفر";
            const reg = getRegionName(nm);
            layer.bindPopup(`${nm}<br>الحالة: ${stLabel}<br>المساحة: ${area} كم²`);
          }
        }).addTo(map);

        const b = selectedLayer.getBounds();
        if (b.isValid()) smoothZoomTo(b, [30, 30]);
      });

      // وسيلة الإيضاح
      const legend = L.control({ position: 'bottomleft', bottom: "100px" });
      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = '<b>حالة المشروع</b><br>';
        ["1", "2", "3"].forEach((k) => {
          div.innerHTML += `<div><i style="background:${STATUS_COLORS[k]}"></i>${STATUS_LABELS[k]}</div>`;
        });
        return div;
      };
      legend.addTo(map);
    })
    .catch(err => {
      console.error('فشل تحميل بيانات المشاريع:', err);
      alert('تعذر تحميل ملف Projects_Boundary.json');
    });
</script>

</body>
</html>

